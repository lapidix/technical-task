service: nextjs-lambda-app

provider:
  name: aws
  runtime: nodejs20.x
  region: ap-northeast-2
  stage: ${opt:stage, 'dev'}
  memorySize: 1024
  timeout: 30
  environment:
    NODE_ENV: production
    BUCKET_NAME: ${self:custom.assetsBucketName}
    BUCKET_KEY_PREFIX: _assets
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - s3:GetObject
          Resource: "arn:aws:s3:::${self:custom.assetsBucketName}/*"

custom:
  assetsBucketName: ${self:service}-assets-${self:provider.stage}

functions:
  nextServer:
    handler: .open-next/server-functions/default/index.handler
    events:
      - httpApi: "*"

  imageOptimization:
    handler: .open-next/image-optimization-function/index.handler
    memorySize: 1536
    events:
      - httpApi:
          path: /_next/image
          method: GET

resources:
  Resources:
    # S3 버킷 - 정적 파일용 (Private)
    AssetsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.assetsBucketName}
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true

    # CloudFront Origin Access Control
    CloudFrontOriginAccessControl:
      Type: AWS::CloudFront::OriginAccessControl
      Properties:
        OriginAccessControlConfig:
          Name: ${self:service}-oac-${self:provider.stage}
          OriginAccessControlOriginType: s3
          SigningBehavior: always
          SigningProtocol: sigv4

    # S3 버킷 정책 - CloudFront OAC에서만 접근 허용
    AssetsBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref AssetsBucket
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal:
                Service: cloudfront.amazonaws.com
              Action: "s3:GetObject"
              Resource: !Sub "${AssetsBucket.Arn}/*"
              Condition:
                StringEquals:
                  AWS:SourceArn: !Sub "arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}"

    # CloudFront Distribution
    CloudFrontDistribution:
      Type: AWS::CloudFront::Distribution
      Properties:
        DistributionConfig:
          Enabled: true
          Comment: "NextJS App Distribution"
          HttpVersion: http2and3
          PriceClass: PriceClass_200
          Aliases:
            - ${env:CUSTOM_DOMAIN}
          ViewerCertificate:
            AcmCertificateArn: ${env:ACM_CERTIFICATE_ARN}
            SslSupportMethod: sni-only
            MinimumProtocolVersion: TLSv1.2_2021
          DefaultCacheBehavior:
            TargetOriginId: api-gateway
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
              - PUT
              - POST
              - PATCH
              - DELETE
            CachedMethods:
              - GET
              - HEAD
            ForwardedValues:
              QueryString: true
              Headers:
                - Authorization
                - Accept
                - Accept-Language
                - CloudFront-Forwarded-Proto
                - Host
                - x-forwarded-host
              Cookies:
                Forward: whitelist
                WhitelistedNames:
                  - __Secure-next-auth.session-token
                  - next-auth.session-token
            MinTTL: 0
            DefaultTTL: 0
            MaxTTL: 0
            Compress: true
          CacheBehaviors:
            # 정적 파일 캐싱 (_next/static/*) - 빌드 해시 포함, 영구 캐싱
            - PathPattern: "/_next/static/*"
              TargetOriginId: s3-assets
              ViewerProtocolPolicy: redirect-to-https
              AllowedMethods:
                - GET
                - HEAD
              CachedMethods:
                - GET
                - HEAD
              ForwardedValues:
                QueryString: false
                Cookies:
                  Forward: none
              MinTTL: 31536000
              DefaultTTL: 31536000
              MaxTTL: 31536000
              Compress: true
            # _next/data/* - SSG/ISR 데이터
            - PathPattern: "/_next/data/*"
              TargetOriginId: api-gateway
              ViewerProtocolPolicy: redirect-to-https
              AllowedMethods:
                - GET
                - HEAD
              CachedMethods:
                - GET
                - HEAD
              ForwardedValues:
                QueryString: true
                Cookies:
                  Forward: none
              MinTTL: 0
              DefaultTTL: 0
              MaxTTL: 31536000
              Compress: true
            # 이미지 최적화
            - PathPattern: "/_next/image*"
              TargetOriginId: api-gateway
              ViewerProtocolPolicy: redirect-to-https
              AllowedMethods:
                - GET
                - HEAD
              CachedMethods:
                - GET
                - HEAD
              ForwardedValues:
                QueryString: true
                Headers:
                  - Accept
              MinTTL: 60
              DefaultTTL: 86400
              MaxTTL: 31536000
              Compress: true
            # 파비콘 및 정적 에셋
            - PathPattern: "/favicon.ico"
              TargetOriginId: s3-assets
              ViewerProtocolPolicy: redirect-to-https
              AllowedMethods:
                - GET
                - HEAD
              CachedMethods:
                - GET
                - HEAD
              ForwardedValues:
                QueryString: false
                Cookies:
                  Forward: none
              MinTTL: 86400
              DefaultTTL: 604800
              MaxTTL: 31536000
              Compress: true
          Origins:
            # API Gateway Origin
            - Id: api-gateway
              DomainName: !Sub "${HttpApi}.execute-api.${AWS::Region}.amazonaws.com"
              CustomOriginConfig:
                HTTPSPort: 443
                OriginProtocolPolicy: https-only
                OriginSSLProtocols:
                  - TLSv1.2
              OriginShield:
                Enabled: true
                OriginShieldRegion: ${self:provider.region}
            # S3 Origin (OAC 사용)
            - Id: s3-assets
              DomainName: !GetAtt AssetsBucket.RegionalDomainName
              S3OriginConfig:
                OriginAccessIdentity: ""
              OriginAccessControlId: !GetAtt CloudFrontOriginAccessControl.Id

  Outputs:
    CloudFrontDistributionId:
      Value: !Ref CloudFrontDistribution
      Description: CloudFront Distribution ID
    CloudFrontDomainName:
      Value: !GetAtt CloudFrontDistribution.DomainName
      Description: CloudFront Domain Name

package:
  patterns:
    - "!node_modules/**"
    - "!.next/**"
    - "!.git/**"
    - ".open-next/**"
